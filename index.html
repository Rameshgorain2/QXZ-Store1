<!DOCTYPE html>
<html lang="en-IN">
<head>
    <!-- SEO & META -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFC107">
    <title>Qxz Store | Live Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Poppins', 'sans-serif'] }, 
                    colors: { brand: { DEFAULT: '#FFC107', dark: '#FFB300' } }
                } 
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { background: #f1f3f6; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .step-section { display: none; }
        .step-section.active { display: flex; flex-direction: column; height: 100%; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* TRACKER LINE CSS */
        .track-line { position: absolute; top: 14px; left: 0; right: 0; height: 3px; background: #e5e7eb; z-index: 0; }
        .track-progress { position: absolute; top: 14px; left: 0; height: 3px; background: #16a34a; z-index: 0; transition: width 0.5s ease; }
    </style>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjw6O7nLDBaT6-UP5nsINrsRrSbcco844",
            authDomain: "qxz-store.firebaseapp.com",
            databaseURL: "https://qxz-store-default-rtdb.firebaseio.com",
            projectId: "qxz-store",
            storageBucket: "qxz-store.firebasestorage.app",
            messagingSenderId: "559563657391",
            appId: "1:559563657391:web:eb7e5fa9fbac44962c845a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db; window.update = update; window.set = set; window.ref = ref; window.push = push;
        window.allProducts = []; window.currentOrderDetails = null;

        window.initApp = function() { showProductSkeleton(); loadProfile(); checkHash(); }

        // --- HASH ROUTING ---
        window.addEventListener('hashchange', checkHash);
        function checkHash() {
            const hash = window.location.hash;
            if(hash.startsWith('#product=')) {
                const id = hash.replace('#product=', '');
                if(window.allProducts.length === 0) setTimeout(checkHash, 500); 
                else openProduct(id, false);
            } else if (hash === '' || hash === '#home') { closeProduct(false); }
        }

        function showProductSkeleton() {
            const list = document.getElementById('product-list'); list.innerHTML = '';
            for(let i=0; i<6; i++) { list.innerHTML += `<div class="bg-white rounded-xl shadow-sm border p-2"><div class="h-40 skeleton rounded-lg mb-3"></div><div class="h-3 skeleton rounded w-3/4 mb-2"></div><div class="h-3 skeleton rounded w-1/2"></div></div>`; }
        }

        // FETCH PRODUCTS (LATEST FIRST)
        onValue(ref(db, 'products'), (snapshot) => {
            const list = document.getElementById('product-list'); list.innerHTML = ''; window.allProducts = [];
            if(snapshot.exists()) {
                document.getElementById('product-loading-title').style.display = 'none';
                
                // 1. Collect Data
                snapshot.forEach((child) => {
                    const p = child.val(); p.id = child.key;
                    if (!p.images) p.images = []; else if (!Array.isArray(p.images)) p.images = [p.images];
                    window.allProducts.push(p);
                });

                // 2. REVERSE ARRAY (LATEST ON TOP)
                window.allProducts.reverse();

                // 3. Render
                window.allProducts.forEach((p) => {
                    const discount = p.old ? Math.round(((p.old - p.price) / p.old) * 100) : 0;
                    list.innerHTML += `<a href="#product=${p.id}" onclick="event.preventDefault(); openProduct('${p.id}')" class="bg-white rounded-xl shadow-sm border overflow-hidden cursor-pointer block group"><div class="h-44 relative bg-gray-50"><img src="${p.images[0]}" class="w-full h-full object-cover mix-blend-multiply transition group-hover:scale-105" loading="lazy"></div><div class="p-3"><h2 class="text-gray-700 text-xs font-medium truncate mb-1">${p.title}</h2><div class="flex items-center gap-2"><span class="font-bold text-gray-900 text-sm">‚Çπ${p.price}</span><span class="text-[10px] text-green-600 font-bold">${discount}% OFF</span></div></div></a>`;
                });
                checkHash();
            }
        });

        // BANNERS
        onValue(ref(db, 'banners'), (snapshot) => {
            if(snapshot.exists()) {
                const track = document.getElementById('home-banner-track'); track.innerHTML = '';
                const urls = Array.isArray(snapshot.val()) ? snapshot.val() : Object.values(snapshot.val());
                urls.forEach((url) => { track.innerHTML += `<div class="slide min-w-full h-full relative"><img src="${url}" class="w-full h-full object-cover rounded-xl shadow-md"></div>`; });
            }
        });

        // SEND ORDER
        window.sendOrderToDb = function(orderData) {
            push(ref(db, 'orders'), orderData).then(() => {
                const userRef = ref(db, 'users/' + orderData.user.phone);
                set(userRef, { name: orderData.user.name, phone: orderData.user.phone, address: orderData.user, lastOrderDate: new Date().toISOString() }).catch(err => console.error(err));
                document.getElementById('success-overlay').classList.remove('hidden');
                document.getElementById('success-overlay').classList.add('flex');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                setTimeout(() => {
                    document.getElementById('success-overlay').classList.add('hidden');
                    document.getElementById('success-overlay').classList.remove('flex');
                    closeCheckout(); switchTab('account'); openMyOrders(); 
                }, 2000);
            }).catch((e) => { alert("Error: " + e.message); document.querySelector('.place-btn').disabled = false; });
        }

        // REVIEWS
        window.submitReview = function() {
            const rating = document.getElementById('rev-rating').value; const text = document.getElementById('rev-text').value;
            if(!text) { alert("Please write something!"); return; }
            const reviewData = { user: window.currentOrderDetails.user.name, rating: rating, text: text, date: new Date().toLocaleDateString() };
            push(ref(db, 'reviews/' + window.currentOrderDetails.product.id), reviewData).then(() => { alert("Review Submitted!"); document.getElementById('review-modal').classList.add('hidden'); closeOrderDetails(); });
        }

        window.loadProductReviews = function(productId) {
            const container = document.getElementById('reviews-container'); container.innerHTML = '<p class="text-xs text-gray-400">Loading reviews...</p>';
            onValue(ref(db, 'reviews/' + productId), (snapshot) => {
                container.innerHTML = '';
                if(snapshot.exists()) {
                    let totalStars = 0, count = 0;
                    snapshot.forEach((child) => {
                        const r = child.val(); totalStars += parseInt(r.rating); count++;
                        container.innerHTML += `<div class="border-b pb-3 mb-3 last:border-0"><div class="flex items-center gap-2 mb-1"><div class="bg-green-600 text-white text-[10px] px-1.5 rounded flex items-center gap-0.5">${r.rating} <i class="fas fa-star text-[8px]"></i></div><span class="text-xs font-bold text-gray-800">${r.user}</span></div><p class="text-xs text-gray-600">${r.text}</p><p class="text-[10px] text-gray-400 mt-1">${r.date} ‚Ä¢ Verified Purchase</p></div>`;
                    });
                    document.getElementById('p-rating-val').innerText = (totalStars / count).toFixed(1);
                    document.getElementById('rating-count').innerText = `${count} Ratings`;
                } else { container.innerHTML = '<div class="text-center py-4"><p class="text-sm font-bold text-gray-400">No Reviews Yet</p></div>'; document.getElementById('p-rating-val').innerText = "New"; document.getElementById('rating-count').innerText = "0 Ratings"; }
            });
        }

        // --- FIXED: LOAD MY ORDERS ---
        window.loadMyOrders = function() {
            const list = document.getElementById('my-orders-list');
            list.innerHTML = '<div class="flex justify-center mt-10"><i class="fas fa-circle-notch fa-spin text-brand text-2xl"></i></div>';
            
            let profile;
            try { profile = JSON.parse(localStorage.getItem('userProfile')); } catch(e) { profile = null; }
            
            // Check if profile exists and has a phone number
            if(!profile || !profile.phone) { 
                list.innerHTML = '<div class="text-center mt-20 text-gray-500"><i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i><p>No orders placed yet.</p></div>'; 
                return; 
            }

            const myPhone = String(profile.phone).trim(); // Normalize

            onValue(ref(db, 'orders'), (snapshot) => {
                list.innerHTML = '';
                if(snapshot.exists()) {
                    const arr = [];
                    snapshot.forEach((child) => { 
                        const ord = child.val(); 
                        ord.id = child.key; 
                        
                        // Strict Matching
                        if(ord.user && String(ord.user.phone).trim() === myPhone) {
                            arr.push(ord);
                        }
                    });

                    if(arr.length === 0) { 
                        list.innerHTML = '<div class="text-center mt-20 text-gray-500"><i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i><p>No active orders.</p></div>'; 
                        return; 
                    }

                    arr.reverse().forEach(ord => {
                        window.myOrdersData = window.myOrdersData || {}; 
                        window.myOrdersData[ord.id] = ord; 
                        
                        // Fallback for missing product data
                        if(!ord.product) ord.product = { title: "Item", image: "", price: "0" };

                        list.innerHTML += `
                            <div onclick="openOrderDetails('${ord.id}')" class="bg-white border mb-3 p-4 rounded-xl flex gap-4 items-center cursor-pointer shadow-sm">
                                <div class="w-16 h-16 bg-gray-50 rounded-lg p-1 flex-shrink-0 border"><img src="${ord.product.image}" class="w-full h-full object-contain"></div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-bold text-gray-800 text-sm truncate">${ord.product.title}</h3>
                                    <p class="text-xs text-gray-400 mt-1">ID: #${ord.id.substring(1,6)}</p>
                                    <span class="px-2 py-1 rounded text-[10px] font-bold ${ord.status==='Delivered' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} mt-2 inline-block">${ord.status}</span>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300"></i>
                            </div>`;
                    });
                } else { 
                    list.innerHTML = '<div class="text-center mt-20 text-gray-500"><p>No orders yet.</p></div>'; 
                }
            });
        }
    </script>
</head>
<body class="text-gray-800 bg-[#f1f3f6]" onload="initApp()">

    <!-- SUCCESS OVERLAY -->
    <div id="success-overlay" class="hidden fixed inset-0 z-[300] bg-white/90 flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-2xl font-bold text-green-600">Order Placed! ü•≥</h2>
    </div>

    <!-- REVIEW MODAL -->
    <div id="review-modal" class="hidden fixed inset-0 z-[400] bg-black/50 flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl">
            <h2 class="text-lg font-bold mb-4">Write a Review</h2>
            <select id="rev-rating" class="w-full border p-2 rounded mb-4"><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option><option value="3">‚≠ê‚≠ê‚≠ê Average</option><option value="1">‚≠ê Bad</option></select>
            <textarea id="rev-text" class="w-full border p-2 rounded h-24 mb-4" placeholder="How was the product?"></textarea>
            <div class="flex gap-3"><button onclick="document.getElementById('review-modal').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded">Cancel</button><button onclick="submitReview()" class="flex-1 bg-brand py-2 rounded font-bold">Submit</button></div>
        </div>
    </div>

    <!-- HOME VIEW -->
    <div id="home-view" class="pb-20">
        <header class="bg-brand sticky top-0 z-40 shadow-sm px-4 py-3 flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-900">Qxz Store</h1>
            <button class="bg-white/20 w-9 h-9 rounded-full relative"><i class="fas fa-shopping-bag text-gray-900"></i><span class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex justify-center items-center">0</span></button>
        </header>

        <div class="mt-4 px-3">
            <div id="home-banner-track" class="slider-container flex overflow-x-auto w-full aspect-video gap-4 snap-x rounded-xl">
                <div class="slide min-w-full h-full skeleton rounded-xl"></div>
            </div>
        </div>

        <div class="px-3 mt-4">
            <h3 id="product-loading-title" class="font-bold text-gray-800 text-sm mb-3">Latest Products</h3>
            <div id="product-list" class="grid grid-cols-2 gap-3"></div>
        </div>

        <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 z-30 shadow-lg">
            <button onclick="switchTab('home')" class="flex flex-col items-center text-brand"><i class="fas fa-home text-xl"></i><span class="text-[10px] font-bold mt-1">Home</span></button>
            <button onclick="switchTab('account')" class="flex flex-col items-center text-gray-400"><i class="fas fa-user text-xl"></i><span class="text-[10px] mt-1">Account</span></button>
        </nav>
    </div>

    <!-- PRODUCT VIEW -->
    <div id="product-view" class="fixed inset-0 bg-white z-[50] overflow-y-auto hidden">
        <button onclick="history.back()" class="absolute top-4 left-4 z-20 w-10 h-10 bg-white/80 backdrop-blur rounded-full shadow flex items-center justify-center text-gray-800"><i class="fas fa-arrow-left"></i></button>
        <div id="p-skeleton" class="w-full h-full absolute inset-0 bg-white z-[60] p-4 hidden"><div class="w-full h-96 skeleton rounded-xl mb-4"></div><div class="h-6 skeleton w-3/4 mb-2"></div><div class="h-4 skeleton w-1/4 mb-6"></div><div class="h-20 skeleton w-full rounded-lg"></div></div>
        <div id="p-content" class="hidden opacity-0">
            <div class="w-full bg-gray-50 h-96 relative"><div id="slider-track" class="slider-container flex overflow-x-auto w-full h-full snap-x"></div><div id="slider-dots" class="absolute bottom-4 left-0 w-full flex justify-center gap-2 z-10"></div></div>
            <div class="px-4 pt-5 pb-24">
                <h1 id="p-title" class="text-lg font-bold text-gray-900 leading-snug mb-1"></h1>
                <div class="flex items-end gap-2 mb-2"><span id="p-price" class="text-3xl font-bold text-gray-900"></span><span id="p-old-price" class="text-sm text-gray-400 line-through mb-1.5"></span><span id="p-disc" class="text-xs font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded mb-1.5"></span></div>
                <div class="flex items-center gap-2 mb-5"><div class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded flex items-center gap-1"><span id="p-rating-val">--</span> <i class="fas fa-star text-[10px]"></i></div><p id="rating-count" class="text-xs text-gray-500 font-medium">Checking Ratings...</p></div>
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-5">
                    <div class="flex items-start gap-3 mb-3 pb-3 border-b border-blue-100"><div class="mt-1"><i class="fas fa-map-marker-alt text-blue-600"></i></div><div><p class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Deliver to</p><p id="user-location" class="text-sm font-bold text-gray-800 leading-tight">Loading...</p></div></div>
                    <div class="flex items-start gap-3"><div class="mt-1"><i class="fas fa-truck text-blue-600"></i></div><div><p class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Delivery By</p><p id="delivery-date" class="text-sm font-bold text-green-700 leading-tight">Calculating...</p></div></div>
                </div>
                <div class="flex gap-3 overflow-x-auto scrollbar-hide mb-6 border-b pb-6"><div class="flex flex-col items-center justify-center bg-gray-50 border rounded-lg px-3 py-2 min-w-[100px] text-center"><i class="fas fa-undo text-brand text-lg mb-1"></i> <span class="text-[10px] font-medium leading-tight">7 Days Return</span></div><div class="flex flex-col items-center justify-center bg-gray-50 border rounded-lg px-3 py-2 min-w-[100px] text-center"><i class="fas fa-money-bill-wave text-brand text-lg mb-1"></i> <span class="text-[10px] font-medium leading-tight">Cash on Delivery</span></div></div>
                <div class="mb-6"><h3 class="font-bold text-base mb-3">Customer Reviews</h3><div id="reviews-container"></div></div>
                <h3 class="font-bold text-sm mb-3 pt-4 border-t">Similar Products</h3><div id="similar-grid" class="grid grid-cols-2 gap-3 pb-4"></div>
            </div>
        </div>
        <div class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-4px_10px_rgba(0,0,0,0.1)] p-2 flex gap-3 z-50"><button onclick="startCheckout()" class="w-full py-3 bg-brand text-gray-900 font-bold rounded-lg shadow text-sm">Buy Now</button></div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkout-view" class="fixed inset-0 z-[200] hidden bg-white flex flex-col h-full w-full">
        <div class="bg-brand px-4 py-4 flex items-center gap-3 shrink-0"><button onclick="closeCheckout()" class="text-gray-900"><i class="fas fa-arrow-left"></i></button><h1 class="text-lg font-bold">Checkout</h1></div>
        <div class="w-full bg-gray-200 h-1.5 shrink-0"><div id="progress-bar" class="bg-green-600 h-1.5 w-1/4 transition-all duration-300"></div></div>
        <div class="flex-1 overflow-y-auto p-6">
            
            <!-- Step 1: Name -->
            <div id="step-1" class="step-section active"><h2 class="text-2xl font-bold mb-2">Name?</h2><input type="text" id="in-name" placeholder="Full Name" class="w-full border-b-2 border-gray-300 py-3 text-lg outline-none mb-10 focus:border-brand transition"><button onclick="nextStep(2)" class="w-full bg-brand font-bold py-3 rounded-xl shadow-lg">Next</button></div>
            
            <!-- Step 2: Mobile -->
            <div id="step-2" class="step-section"><h2 class="text-2xl font-bold mb-2">Mobile?</h2><input type="number" id="in-phone" placeholder="10 Digit Number" class="w-full border-b-2 border-gray-300 py-3 text-lg outline-none mb-10 focus:border-brand transition"><div class="flex gap-4"><button onclick="nextStep(1)" class="w-1/3 bg-gray-200 py-3 rounded-xl">Back</button><button onclick="nextStep(3)" class="w-2/3 bg-brand font-bold py-3 rounded-xl shadow-lg">Next</button></div></div>
            
            <!-- Step 3: Address -->
            <div id="step-3" class="step-section">
                <h2 class="text-xl font-bold mb-4">Delivery Details</h2>
                <div class="space-y-4">
                    <input type="text" id="in-village" placeholder="Village / Colony" class="w-full border rounded p-3">
                    <input type="text" id="in-post" placeholder="Post Office" class="w-full border rounded p-3">
                    <div class="flex gap-3"><input type="text" id="in-city" placeholder="City" class="w-1/2 border rounded p-3"><input type="number" id="in-pincode" placeholder="Pincode" oninput="autoDetectState()" class="w-1/2 border rounded p-3"></div>
                    
                    <!-- FULL LIST OF INDIAN STATES -->
                    <select id="in-state" class="w-full border rounded p-3 bg-white">
                        <option value="">Select State</option>
                        <option value="Andhra Pradesh">Andhra Pradesh</option><option value="Arunachal Pradesh">Arunachal Pradesh</option><option value="Assam">Assam</option><option value="Bihar">Bihar</option><option value="Chhattisgarh">Chhattisgarh</option><option value="Goa">Goa</option><option value="Gujarat">Gujarat</option><option value="Haryana">Haryana</option><option value="Himachal Pradesh">Himachal Pradesh</option><option value="Jharkhand">Jharkhand</option><option value="Karnataka">Karnataka</option><option value="Kerala">Kerala</option><option value="Madhya Pradesh">Madhya Pradesh</option><option value="Maharashtra">Maharashtra</option><option value="Manipur">Manipur</option><option value="Meghalaya">Meghalaya</option><option value="Mizoram">Mizoram</option><option value="Nagaland">Nagaland</option><option value="Odisha">Odisha</option><option value="Punjab">Punjab</option><option value="Rajasthan">Rajasthan</option><option value="Sikkim">Sikkim</option><option value="Tamil Nadu">Tamil Nadu</option><option value="Telangana">Telangana</option><option value="Tripura">Tripura</option><option value="Uttar Pradesh">Uttar Pradesh</option><option value="Uttarakhand">Uttarakhand</option><option value="West Bengal">West Bengal</option><option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option><option value="Chandigarh">Chandigarh</option><option value="Dadra and Nagar Haveli">Dadra and Nagar Haveli</option><option value="Daman and Diu">Daman and Diu</option><option value="Delhi">Delhi</option><option value="Lakshadweep">Lakshadweep</option><option value="Puducherry">Puducherry</option><option value="Jammu and Kashmir">Jammu and Kashmir</option><option value="Ladakh">Ladakh</option>
                    </select>
                </div>
                <div class="flex gap-4 mt-6"><button onclick="nextStep(2)" class="w-1/3 bg-gray-200 py-3 rounded-xl">Back</button><button onclick="nextStep(4)" class="w-2/3 bg-brand font-bold py-3 rounded-xl shadow-lg">Next</button></div>
            </div>

            <!-- Step 4: Payment -->
            <div id="step-4" class="step-section">
                <h2 class="text-xl font-bold mb-4">Payment Method</h2>
                <div class="flex gap-4 bg-gray-50 p-3 rounded-lg border mb-6"><img id="checkout-img" class="w-16 h-16 object-cover rounded border"><div><p id="checkout-title" class="font-bold text-sm line-clamp-1"></p><p id="checkout-price" class="font-bold text-lg text-green-700"></p></div></div>
                <div class="space-y-3">
                    <div onclick="finalizePayment('cod')" class="border-2 border-brand bg-yellow-50 p-4 rounded-xl flex items-center justify-between cursor-pointer"><div class="flex items-center gap-3"><i class="fas fa-money-bill-wave text-green-600 text-xl"></i><div><p class="font-bold text-sm">Cash on Delivery</p><p class="text-xs text-gray-500">Pay when you receive</p></div></div><i class="fas fa-check-circle text-brand text-xl"></i></div>
                    <div class="border p-4 rounded-xl flex items-center justify-between opacity-50 cursor-not-allowed"><div class="flex items-center gap-3"><i class="fas fa-credit-card text-gray-400 text-xl"></i><div><p class="font-bold text-sm text-gray-500">Online Payment</p><p class="text-xs text-gray-400">Coming Soon</p></div></div></div>
                </div>
                <div class="flex gap-4 mt-8"><button onclick="nextStep(3)" class="w-1/3 bg-gray-200 py-3 rounded-xl">Back</button><button onclick="placeOrder()" class="w-2/3 bg-brand font-bold py-3 rounded-xl place-btn shadow-lg">Confirm Order</button></div>
            </div>

        </div>
    </div>

    <!-- ACCOUNT VIEW -->
    <div id="account-view" class="pb-20 hidden">
        <div class="bg-brand p-6 text-center"><div class="w-20 h-20 bg-white rounded-full mx-auto flex items-center justify-center border-4 border-white/50 mb-3"><i class="fas fa-user text-3xl text-gray-400"></i></div><h1 class="text-xl font-bold text-gray-900">My Profile</h1></div>
        <div class="p-4"><button onclick="openMyOrders()" class="w-full bg-white border p-4 rounded-xl shadow-sm flex items-center justify-between mb-4"><span class="font-bold flex items-center gap-3"><i class="fas fa-box text-brand-dark"></i> My Orders</span><i class="fas fa-chevron-right text-gray-400"></i></button><div class="bg-white rounded-xl shadow-sm p-4 mb-4 border"><h2 class="font-bold mb-2 text-sm">SAVED INFO</h2><input type="text" id="acc-name" class="w-full border-b py-1 text-sm bg-transparent mb-2" readonly><input type="text" id="acc-phone" class="w-full border-b py-1 text-sm bg-transparent" readonly></div></div>
        <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 z-30 shadow-lg"><button onclick="switchTab('home')" class="flex flex-col items-center text-gray-400"><i class="fas fa-home text-xl"></i><span class="text-[10px] mt-1">Home</span></button><button onclick="switchTab('account')" class="flex flex-col items-center text-brand"><i class="fas fa-user text-xl"></i><span class="text-[10px] font-bold mt-1">Account</span></button></nav>
    </div>

    <!-- MY ORDERS LIST -->
    <div id="my-orders-view" class="fixed inset-0 z-[300] hidden bg-gray-50 overflow-y-auto">
        <div class="bg-white border-b px-4 py-4 flex items-center gap-3 sticky top-0 z-50"><button onclick="closeMyOrders()" class="text-gray-800 text-lg"><i class="fas fa-arrow-left"></i></button><h1 class="text-lg font-bold">My Orders</h1></div><div id="my-orders-list" class="p-4"></div>
    </div>

    <!-- ORDER DETAILS -->
    <div id="order-details-view" class="fixed inset-0 z-[350] hidden bg-white overflow-y-auto">
        <div class="bg-white border-b px-4 py-4 flex items-center justify-between sticky top-0 z-50"><div class="flex items-center gap-3"><button onclick="closeOrderDetails()" class="text-gray-800"><i class="fas fa-arrow-left"></i></button><h1 class="font-bold">Order Details</h1></div><div class="relative"><button onclick="toggleOrderMenu()" class="w-8 h-8 flex items-center justify-center"><i class="fas fa-ellipsis-v"></i></button><div id="order-menu-dropdown" class="hidden absolute right-0 top-8 bg-white shadow-lg border rounded w-40 py-2 z-50"><button onclick="requestCancellation()" id="cancel-btn" class="w-full text-left px-4 text-sm text-red-600 font-bold">Cancel Order</button></div></div></div><div id="od-content" class="p-4"></div><div id="review-action-area" class="p-4"></div>
    </div>

    <script>
        // --- LOGIC ---
        
        window.openProduct = function(id, setHash = true) {
            currentProduct = window.allProducts.find(p=>p.id==id);
            if(!currentProduct) return;
            if(setHash) window.history.pushState(null, null, '#product=' + id);
            
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('product-view').classList.remove('hidden');
            document.getElementById('product-view').scrollTop = 0; 

            // RESET LAYOUT
            document.getElementById('p-skeleton').classList.remove('hidden');
            document.getElementById('p-content').classList.add('hidden');
            document.getElementById('p-content').classList.remove('fade-in');

            // POPULATE
            document.getElementById('p-title').innerText = currentProduct.title;
            document.getElementById('p-price').innerText = `‚Çπ${currentProduct.price}`;
            document.getElementById('p-old-price').innerText = `‚Çπ${currentProduct.old}`;
            document.getElementById('p-disc').innerText = currentProduct.old ? Math.round(((currentProduct.old - currentProduct.price)/currentProduct.old)*100) + "% OFF" : "";
            document.getElementById('p-rating-val').innerText = (Math.random() * (4.8 - 4.0) + 4.0).toFixed(1);

            // DATE
            const d = new Date(); d.setDate(d.getDate() + 8);
            document.getElementById('delivery-date').innerText = d.toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });

            // LOCATION
            const profile = JSON.parse(localStorage.getItem('userProfile'));
            if(profile && profile.city && profile.pin) {
                document.getElementById('user-location').innerText = `${profile.city} - ${profile.pin}`;
            } else {
                document.getElementById('user-location').innerText = "Add Address at Checkout";
            }

            // SLIDER
            const tr = document.getElementById('slider-track'); 
            const dots = document.getElementById('slider-dots');
            tr.innerHTML=''; dots.innerHTML='';
            
            currentProduct.images.forEach((img, idx)=> {
                const imgEl = new Image();
                imgEl.src = img;
                imgEl.className = "w-full h-full object-contain p-4";
                
                if(idx === 0) {
                    imgEl.onload = () => {
                        setTimeout(() => { 
                            document.getElementById('p-skeleton').classList.add('hidden');
                            document.getElementById('p-content').classList.remove('hidden');
                            document.getElementById('p-content').classList.add('fade-in');
                        }, 400); 
                    };
                }

                const div = document.createElement('div');
                div.className = "slide min-w-full h-full bg-white flex justify-center items-center";
                div.appendChild(imgEl);
                tr.appendChild(div);

                if(currentProduct.images.length > 1) dots.innerHTML += `<div id="p-dot-${idx}" class="w-2 h-2 rounded-full bg-gray-300"></div>`;
            });
            
            // SIMILAR
            const sim = document.getElementById('similar-grid'); sim.innerHTML='';
            let similar = window.allProducts.filter(p => p.id != id && p.category == currentProduct.category).slice(0,4);
            if(similar.length < 2) similar = similar.concat(window.allProducts.filter(p=>p.id!=id && p.id!=currentProduct.id).slice(0, 4-similar.length));
            similar.forEach(p => sim.innerHTML += `<div onclick="openProduct('${p.id}')" class="bg-white rounded-lg border p-2"><img src="${p.images[0]}" class="w-full h-32 object-contain mb-2"><h4 class="text-xs truncate font-bold">${p.title}</h4><span class="text-sm font-bold">‚Çπ${p.price}</span></div>`);
        }

        window.closeProduct = function(resetHash=true) { 
            document.getElementById('product-view').classList.add('hidden'); 
            document.getElementById('home-view').classList.remove('hidden'); 
            if(resetHash) history.pushState(null, null, ' ');
        }

        window.switchTab = function(t) {
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('account-view').classList.add('hidden');
            document.getElementById(t+'-view').classList.remove('hidden');
        }
        
        window.closeCheckout = function() { document.getElementById('checkout-view').classList.add('hidden'); }
        window.closeMyOrders = function() { document.getElementById('my-orders-view').classList.add('hidden'); }
        window.closeOrderDetails = function() { document.getElementById('order-details-view').classList.add('hidden'); }
        window.toggleOrderMenu = function() { document.getElementById('order-menu-dropdown').classList.toggle('hidden'); }
        
        // --- FIXED: OPEN MY ORDERS ---
        window.openMyOrders = function() {
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('account-view').classList.add('hidden');
            document.getElementById('product-view').classList.add('hidden');
            document.getElementById('checkout-view').classList.add('hidden');
            
            document.getElementById('my-orders-view').classList.remove('hidden');
            loadMyOrders();
        }

        window.startCheckout = function() {
            if(!currentProduct) return alert("Product not loaded");
            document.getElementById('checkout-view').classList.remove('hidden');
            loadProfile();
            document.querySelectorAll('.step-section').forEach(el=>el.classList.remove('active'));
            document.getElementById('step-1').classList.add('active');
            document.getElementById('progress-bar').style.width = "25%";
        }

        window.nextStep = function(s) {
            if(s===2 && !document.getElementById('in-name').value) { document.getElementById('in-name').style.borderColor="red"; return; } 
            if(s===3 && document.getElementById('in-phone').value.length !== 10) { document.getElementById('in-phone').style.borderColor="red"; return; } 
            
            // Payment Page Setup (Step 4)
            if(s===4) {
                if(!document.getElementById('in-city').value) return alert("Address Required");
                // Save Profile Here
                const data = {name: document.getElementById('in-name').value, phone: document.getElementById('in-phone').value, village: document.getElementById('in-village').value, post: document.getElementById('in-post').value, city: document.getElementById('in-city').value, pin: document.getElementById('in-pincode').value, state: document.getElementById('in-state').value};
                localStorage.setItem('userProfile', JSON.stringify(data));
                
                // Show Product in Payment Page
                document.getElementById('checkout-img').src = currentProduct.images[0];
                document.getElementById('checkout-title').innerText = currentProduct.title;
                document.getElementById('checkout-price').innerText = `‚Çπ${currentProduct.price}`;
            }

            document.getElementById('in-name').style.borderColor="#e5e7eb"; document.getElementById('in-phone').style.borderColor="#e5e7eb"; 
            document.querySelectorAll('.step-section').forEach(el=>el.classList.remove('active')); 
            document.getElementById(`step-${s}`).classList.add('active'); 
            const prog = s===1 ? '25%' : (s===2 ? '50%' : (s===3 ? '75%' : '100%'));
            document.getElementById('progress-bar').style.width = prog; 
        }
        
        window.autoDetectState = function() {
            const map = {'11':'Delhi','40':'Maharashtra','20':'Uttar Pradesh','30':'Rajasthan','80':'Bihar'}; 
            const val = document.getElementById('in-pincode').value.substring(0,2);
            if(map[val]) document.getElementById('in-state').value = map[val];
        }

        window.placeOrder = function() { 
            const profile = JSON.parse(localStorage.getItem('userProfile')); 
            const btn = document.querySelector('.place-btn'); btn.innerHTML="Wait..."; btn.disabled=true; 
            const orderPayload = { user: profile, product: { id: currentProduct.id, title: currentProduct.title, price: currentProduct.price, image: currentProduct.images[0] }, date: new Date().toISOString(), status: 'Placed' }; 
            window.sendOrderToDb(orderPayload); 
        }
        
        window.requestCancellation = function() { if(confirm("Cancel?")) { window.update(window.ref(window.db, 'orders/' + window.currentOrderDetails.id), { cancelRequest: 'pending' }).then(() => { alert("Requested."); window.closeOrderDetails(); window.loadMyOrders(); }); } }
        
        // UPDATED TRACKING UI
        window.openOrderDetails = function(id) { 
            const ord = window.myOrdersData[id]; if(!ord) return; window.currentOrderDetails = ord; 
            document.getElementById('order-details-view').classList.remove('hidden'); 
            
            // Logic for Horizontal Tracker
            let w = '0%';
            let c2='gray', c3='gray';
            if(ord.status === 'Shipped') { w = '50%'; c2='green'; }
            if(ord.status === 'Delivered') { w = '100%'; c2='green'; c3='green'; }

            // Dots Styling
            const dotClass = "w-4 h-4 rounded-full z-10 border-2 border-white box-content";
            
            document.getElementById('od-content').innerHTML = `
                <div class="flex gap-4 mb-4 border p-3 rounded bg-white"><img src="${ord.product.image}" class="w-16 h-16 object-contain"><div><h3 class="font-bold text-sm">${ord.product.title}</h3><p class="font-bold">‚Çπ${ord.product.price}</p></div></div>
                
                <!-- TRACKER -->
                <div class="bg-white p-4 rounded-lg border mb-4 relative overflow-hidden">
                    <h3 class="font-bold text-sm mb-4">Order Status</h3>
                    <div class="relative mb-6 mx-2">
                        <div class="track-line"></div>
                        <div class="track-progress" style="width: ${w}"></div>
                        <div class="flex justify-between relative">
                            <!-- Dot 1 -->
                            <div class="flex flex-col items-center">
                                <div class="${dotClass} bg-green-600"></div>
                                <p class="text-[10px] mt-1 font-bold">Ordered</p>
                                <p class="text-[9px] text-gray-400">${new Date(ord.date).toLocaleDateString()}</p>
                            </div>
                            <!-- Dot 2 -->
                            <div class="flex flex-col items-center">
                                <div class="${dotClass} bg-${c2==='green'?'green-600':'gray-300'}"></div>
                                <p class="text-[10px] mt-1 text-gray-500">Shipped</p>
                            </div>
                            <!-- Dot 3 -->
                            <div class="flex flex-col items-center">
                                <div class="${dotClass} bg-${c3==='green'?'green-600':'gray-300'}"></div>
                                <p class="text-[10px] mt-1 text-gray-500">Delivered</p>
                            </div>
                        </div>
                    </div>
                    ${ord.cancelRequest ? '<p class="text-red-500 text-xs font-bold text-center bg-red-50 p-2 rounded">Cancellation Pending</p>' : ''}
                </div>

                <div class="border p-4 rounded text-sm"><p class="font-bold text-gray-500 text-xs uppercase mb-2">Shipping Address</p><p class="font-bold">${ord.user.name}</p><p class="text-gray-600">${ord.user.village}, ${ord.user.city}</p><p class="text-gray-600">${ord.user.state} - ${ord.user.pin}</p><p class="text-gray-600 font-bold mt-1">Phone: ${ord.user.phone}</p></div>
            `; 
            
            const revArea = document.getElementById('review-action-area'); revArea.innerHTML = ''; 
            if(ord.status === 'Delivered') { revArea.innerHTML = `<button onclick="document.getElementById('review-modal').classList.remove('hidden')" class="w-full bg-brand py-3 rounded-lg font-bold shadow">Write a Review</button>`; } 
            
            const btn = document.getElementById('cancel-btn'); 
            if(ord.status === 'Delivered' || ord.status === 'Cancelled' || ord.cancelRequest) { btn.classList.add('opacity-50', 'pointer-events-none'); btn.innerText = ord.status === 'Cancelled' ? "Cancelled" : (ord.cancelRequest ? "Request Pending" : "Cannot Cancel"); } else { btn.classList.remove('opacity-50', 'pointer-events-none'); btn.innerText = "Cancel Order"; } 
        }
        
        window.loadProfile = function() { let p; try { p = JSON.parse(localStorage.getItem('userProfile')); } catch(e) { p=null; } if(p) { document.getElementById('in-name').value = p.name || ''; document.getElementById('in-phone').value = p.phone || ''; document.getElementById('in-village').value = p.village || ''; document.getElementById('in-post').value = p.post || ''; document.getElementById('in-city').value = p.city || ''; document.getElementById('in-pincode').value = p.pin || ''; document.getElementById('in-state').value = p.state || ''; document.getElementById('acc-name').value = p.name || ''; document.getElementById('acc-phone').value = p.phone || ''; } }
    </script>
</body>
</html>